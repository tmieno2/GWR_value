---
title: "Bias in the Estimation of the Value of VRA over URA: A case of Mis-speficied Geographically Weighted Regression Models"
author:
  - Taro Mieno^[University of Nebraska Lincoln, tmieno2@unl.edu], Xiaofei Li^[Mississippi State University, xiaofei.li@msstate.edu], David S. Bullock^[University of Illinois, dsbulloc@illinois.edu]
output:
  officedown::rdocx_document:
    toc: false
    toc_depth: 1
    number_sections: true
    reference_docx: "word_template.docx"
    base_format: "bookdown::word_document2"
    plots:
      style: Normal
      align: center
      caption:
       style: Image Caption
       pre: "Figure "
       sep: ": "
    tables:
      style: Table
      layout: autofit
      width: 1.0
      caption:
       style: Table Caption
       pre: "Table "
       sep: ": "
bibliography: PA.bib
csl: field-crops-research.csl
abstract: ""
---

```{r echo = F, cache = F}
suppressMessages(library(knitr))
suppressMessages(library(here))
suppressMessages(library(officedown))
suppressMessages(library(officer))

opts_chunk$set(
  fig.align = "center",
  fig.retina = 6,
  warning = FALSE,
  message = FALSE,
  cache = FALSE,
  echo = FALSE,
  fig.cap = TRUE
)
```

```{r cache = F}
#--- packages ---#
library(data.table)
library(tidyverse)
library(flextable)
library(stringr)
library(sf)
library(lfe)
library(modelsummary)
library(patchwork)
library(ggplot2)
```

```{r figure_setup, cache = F}
theme_update(
  axis.title.x =
    element_text(
      size = 12, angle = 0, hjust = .5, vjust = -0.3, family = "Times"
    ),
  axis.title.y =
    element_text(
      size = 12, angle = 90, hjust = .5, vjust = .9, family = "Times"
    ),
  axis.text.x =
    element_text(
      size = 10, angle = 0, hjust = .5, vjust = 1.5, family = "Times"
    ),
  axis.text.y =
    element_text(
      size = 10, angle = 0, hjust = 1, vjust = 0, family = "Times"
    ),
  axis.ticks =
    element_line(
      size = 0.3, linetype = "solid"
    ),
  axis.ticks.length = unit(.15, "cm"),
  #--- legend ---#
  legend.text =
    element_text(
      size = 10, angle = 0, hjust = 0, vjust = 0, family = "Times"
    ),
  legend.title =
    element_text(
      size = 10, angle = 0, hjust = 0, vjust = 0, family = "Times"
    ),
  legend.key.size = unit(0.5, "cm"),
  #--- strip (for faceting) ---#
  strip.text = element_text(size = 9),
  #--- plot title ---#
  plot.title = element_text(family = "Times", face = "bold", size = 12),
  #--- margin ---#
  # plot.margin = margin(0, 0, 0, 0, "cm"),
  #--- panel ---#
  panel.grid.major = element_blank(),
  panel.grid.minor = element_blank(),
  panel.background = element_blank(),
  panel.border = element_rect(fill = NA)
)
```

```{r include = FALSE}
#| include: false

# /*===========================================================
#' # Prepare data and results for writing
# /*===========================================================
#* source all the functions in the Functions folder
fs::dir_ls(here("GitControlled/Codes/Functions"), full.names = TRUE) %>%
  lapply(., function(x) source(x))

#* read the results rds file
results <-
  here("Shared/Results/gaussian/pi_data.rds") %>%
  readRDS() %>%
  .[, type := ifelse(transfer == 0, "GWRR", "GWRT")] %>%
  .[, bias := pi_diff_est - pi_diff] %>%
  # only display the 25% (5.44), 50% (6.56), 75% (7.67) price ratio
  .[pRatio %in% c(5.44, 6.56, 7.67), ] %>%
  # === label price ratio
  .[, pLabelName := "Price Ratio (N/corn)"] %>%
  .[pRatio == 5.44, pLabel := "Low (5.44)"] %>%
  .[pRatio == 6.56, pLabel := "Middle (6.56)"] %>%
  .[pRatio == 7.67, pLabel := "High (7.67)"] %>%
  .[, pLabel := factor(pLabel, levels = c("Low (5.44)", "Middle (6.56)", "High (7.67)"))]

mean_data_value <-
  results %>%
  .[, .(pi_diff = median(pi_diff)),
    by = c("field_col", "pLabel", "type")
  ]
```

```{r, include = FALSE}
knitr::purl(here("GitControlled/Codes/3_make_figures_publication.rmd"), here("GitControlled/Codes/3_make_figures_publication.R"))
source(here("GitControlled/Codes/3_make_figures_publication.R"))
```

**Abstract**: Geographically weighted regression (GWR) has been presented as a valuable tool for the estimation of site-specific yield response functions used to derive site-specific input rate recommendations from data generated by on-farm precision experimentation (OFPE). But most of the applications of GWR in this context have assumed a quadratic yield response function, despite a scientific consensus that the yield-input relationships modeled are better represented by the quadratic-plateau functional form. The key objective of this paper is to investigate whether, when the true functional form of yield response is quadratic-plateau, assuming a quadratic form introduces bias into the GWR estimation of the economic value of site-specific recommendation maps. We consider two sets of functional-form specifications used by recently published studies of site-specific input management that apply GWR to data from OFPE. We show that both GWR approaches suffer significant positive bias, which can lead to large over-estimation of the economic value of applying GWR methods. We conclude that in many circumstances the information gleaned from using GWR may be far less valuable than has been claimed.  We encourage the statistical community to develop tools in software packages providing GWR that allow more flexibility in functional form assumptions. 

**Keywords**: on-farm precision experimentation, site-specific input management, geographically weighted regression, economically optimal nitrogen rate

**Acknowledgements**: This research was supported by a USDA-NIFA-AFRI Food Security Program Coordinated Agricultural Project, titled "Using Precision Technology in On-farm Field Trials to Enable Data-Intensive Fertilizer Management," (Accession Number 2016-68004-24769), and also by the a USDA-NRCS Conservation Innovation Grant from the On-farm Trials Program, titled "Improving the Economic and Ecological Sustainability of US Crop Production through On-Farm Precision Experimentation" (Award Number NR213A7500013G021), and by USDA NIFA's Hatch Project 470-362.

`r run_pagebreak()`

# Introduction

Precision agriculture technology enables the tailoring of input management strategies to the unique spatial and temporal variations in soil and crop conditions within a field. In recent decades, there has been a surge in technological advancements for collecting comprehensive field data (such as yield mapping, soil sampling, and remote sensing), which has facilitated the development of site-specific management recommendations. Recently, on-farm precision experimentation (OFPE) has emerged as a popular method among agricultural researchers and practitioners. It provides a cost-effective way to gather high-resolution data on yields and input trials, which is crucial for informing site-specific crop input management [@bullock2019data; @lacoste2021farm for reference]. One of the enduring research questions in this domain is the value of variable rate application (VRA) of inputs like fertilizer and seeds compared to traditional uniform rate application (URA). This is a pivotal question, as the answer determines whether the investment in costly precision agriculture technologies, conducting soil sampling, or purchasing variable rate prescription maps is justifiable for farmers.

Unfortunately, the estimation of the value of variable rate application (VRA) over uniform rate application (URA) is intrinsically subject to bias. Generally, researchers undertake the following steps to estimate the value of VRA using on-farm precision experimentation (OFPE) data [@anselin2004spatial; @bullock2002adding; @liu2006site; @swinton1998evaluating]: (1) estimate site-specific yield response functions based on a method chosen by the researcher; (2) use the estimated yield response functions to estimate the economically optimal site-specific input rates (EOIRs) and economically optimal uniform input rates; (3) plug the estimated site-specific EOIRs and uniform EOIR into the estimated yield response functions to calculate estimated profits under both strategies; and (4) find the difference in the two strategies' estimated profits. The core source of bias lies in step (3). The primary source of bias originates from step (3), where it is implicitly assumed that the estimated site-specific yield response functions are accurate representations of reality. This is a challenging assumption because the true site-specific yield response functions are ultimately unknowable. As such, when the estimated functions diverge significantly from the true functions, it follows that the estimated value of VRA over URA will also be biased. This bias could manifest as either an underestimation or overestimation of VRA's value. The bias can be exacerbated by mis-specification of the functional form, as this can lead to immediate misrepresentation of the true yield response, further skewing the estimated value of VRA. 

Two primary approaches exist for deriving variable rate application (VRA) recommendations from on-farm precision experimentation (OFPE) data. The first approach integrates soil sampling and/or field characteristic data (such as topography) with OFPE data (yield, input) to estimate site-specific yield response functions. A variety of statistical methods are employed within this framework, including spatial econometrics [@anselin2004spatial; @liu2006site] and various machine learning techniques like random forests [@krause2020random; @de2023predicting], convolutional neural networks [@barbosa2020modeling], and causal forests [@kakimoto2022causal]. The second approach is characteristic-agnostic, represented by geographically weighted regression (GWR). This technique performs localized regressions using yield and input data from surrounding points near the site of interest [@rakshit2020; @evans2020assessment; @trevisan2021spatial]. Consequently, it can estimate site-specific yield response functions without needing data on specific site characteristics. The advantage here is the circumvention of potentially expensive soil sampling or sensing operations^[On any given field, it is typical for many row crop farmers to pay for 1-ha (2.5-ac) grid soil sampling and chemical analysis every three or four years [@morris2018strengths]. The high expense of soil sampling and analysis is also driving development of new sensor technologies that gather data on site-specific field and crop characteristics or proxies of those characteristics, for example, mounted optical sensors for vegetative index (Trimble Agriculture's GreenSeeker and AgLeader's OptRx), towed soil sensor for electroconductivity data (Veris Technologies), etc. Those data are then converted into recommended input application rate maps (usually called "prescriptions" or "$R_x$s") by applying formulas provided by agricultural companies (e.g., FieldRevealTM, FieldApex) or university extension services (e.g., @culman2020tri). But deploying sophisticated sensors to gather field characteristics data is also costly, and the effects of their generation and use on farming profitability remains in question [@gardner2021economic]].

Among the GWR studies, @trevisan2021spatial utilized GWR to estimate site-specific yield response functions from OFPE data and reported an unusually high potential gain of $58 per hectare from transitioning from the optimal uniform application rate to optimal site-specific application rates. Such a figure is notably higher than what has been suggested by previous studies on the value of variable rate application (VRA) over uniform rate application (URA) [@bullock1998does; @koch2004economic; @thrikawala1999economic]. We suspect that their reported estimate for the benefit of GWR-based VRA over URA may be significantly over-estimated for a couple of reasons. First, their model for corn yield response to nitrogen is mostly likely mis-specified. Numerous past agronomic studies recognize that corn yield follows a quadratic-plateau response to nitrogen, yet a simple quadratic model was employed by @trevisan2021spatial. Second, GWR itself has faced criticism regarding the statistical reliability of its coefficient estimations [@griffith2008spatial; @harris2019simulation; @paez2011simulation; @da2016multiple]. We hypothesize that the intersection of these two issues—the model mis-specification and the inherent limitations of GWR—may have led to a substantial overestimation of the economic value of switching from URA to VRA.

The primary objective of this study is to examine the degree and direction of bias in the estimation of the economic value of GWR-based variable nitrogen rate recommendations, especially when the yield response to nitrogen is incorrectly specified as quadratic in the GWR model instead of the correct quadratic-plateau function.  We will employ Monte Carlo simulations, which allow us to accurately define and know the true yield response function within our data-generating process, providing a means to quantify the degree of bias present. 

Differing from the works of @griffith2008spatial, @harris2019simulation, @paez2011simulation, and @da2016multiple, our goal is not to critique the bias in GWR's coefficient estimates per se. Instead, we seek to assess the economic repercussions^[Note that while the environmental consequences of fertilizer management carry significant societal importance, they fall outside the purview of this study. Herein, "economically optimal" pertains strictly to the maximization of private production profitability for farmers and does not imply "socially optimal."] stemming from functional form mis-specifcatin combined with statistical inaccuracies in the coefficient estimation of the model. Wd found that a mis-specified GWR model tends to result in substantial over-estimation of the economic value of GWR-based VRA over URA.

# Methods: Monte Carlo Simulations

This study conducte Monte Carlo simulations to evaluate two sets of GWR quadratic specifications used in @rakshit2020 and @trevisan2021spatial in terms of their economic performance and also bias in estiamting the value of VRA over URA. Both specifications assume a quadratic response of yield to nitrogen rate (N). However, while @trevisan2021spatial estimated the coefficient on N$^2$ as a global parameter, @rakshit2020 estimated it locally for each point. We cannot use real data to test which model specification results in more profitable site-specific nitrogen rate recommendations because it is impossible to observe the true yield response functions using real-world data. For the same reason, neither can we test whether @trevisan2021spatial over-estimate the actual value of VRA. But in the Monte Carlo simulations we specify yield response functions and generated stylized data from those functions, which enable us to quantify in the context of the simulations the value of GWR and the bias in GWR-based estimation of the value of VRA. Monte Carlo simulations are commonly used in this way to gain insights into the statistical and economic properties of trial designs and estimations methods [@alesso2021design; @bullock2020value; @gebbers2010application; @mckinion2001analysis].  We conduct one thousand rounds of Monte Carlo simulation to answer our research questions. The process and components of the simulation analysis are detailed below. 

Our simulations are run using R \citep{}, and all the R programs are publicly accessible at the following GitHub direcotr: https://github.com/tmieno2/GWR_value.

## Experimental Field Layout

Figure \@ref(fig:field-layout) shows a simulated field's layout and defines the spatial units of the simulated OFPEs. The basic spatial unit of the field is a 6m $\times$ 6m "cell", which is the resolution at which the field characteristics data (i.e., parameters of the "true" yield response function) were allowed to vary. It was assumed, however, that yields could not be monitored at such a high resolution. Rather, the mechanical harvester was assumed to be 18m wide, and, in cases in which the N rate was unchanged, in need of harvesting on a run of no less than 12m to provide accurate yield data. Therefore, the yield data's resolution was 18m $\times$ 12m (3 cells $\times$ 2 cells, called a "subplot"). The N rate unit was 18m $\times$ 72m (3 cells $\times$ 12 cells, called a "plot") to accommodate the variable-rate applicator's application resolution. A 12m "transition zone" was placed between two plots (that is, a 6m "transition zone" on each end of a plot), so that when the experimental N rate changed, the harvester had 12m to "clear" and begin to record accurately on a plot with an N rate different from its predecessor's. This means that each N "plot" consists of five effective "subplots" for data analysis.

The field was 432m (72 cells) wide and 864m (144 cells) long, making its area 37.3 ha. Data from the 6m-long headlands, side-lands (there are no transition zones on the north and south ends of the field), and 12m-wide "transition zones" were not included in the analysis. In total, simulated data from 1440 subplots were used for data analysis. The index $j \in {1, 2, \dots, 1440}$ identifies the field's subplots, and the index $i \in {1, \dots , 6}$ identifies the cells within a subplot. The couplet $(j, i)$ is used to identify individual cells.

## True Cell-specific Yield Response Function

An extensive literature examines the choice of functional form in yield response estimation [@cerrato1990comparison; @frank1990comparison; @bullock1994quadratic; @tembo2008crop]. Our simulation assumed that each cell $(j, i)$'s "true" yield response function followed the quadratic-plateau functional form because our main objective was to find the bias associated with using a quadratic functional form in GWR when the true yield response function followed the quadratic-plateau functional form:

$$
\begin{equation} \tag{1}
y_{j,i} = f_{j,i} (N) = f(N, c_{j,i}) = 
  \begin{cases}
  \alpha_{j,i} + \beta_{j,i} N + \gamma_{j,i} N^2 + \varepsilon_{j,i} \, ,& N < \tau_{j,i} \\
  \alpha_{j,i} + \beta_{j,i} \tau_{j,i} + \gamma_{j,i} \tau_{j,i}^2 + \varepsilon_{j,i} \, ,& N \ge \tau_{j,i}
  \end{cases}
\end{equation}
$$

where $\textbf{c}_{j,i} = (\alpha_{j,i},\beta_{j,i},\gamma_{j,i},\tau_{j,i})$ is the vector of yield response function parameters. $\tau_{j,i}$ can be interpreted as the critical value of N rate at which cell $(j, i)$'s yield reaches its plateau, where yield no longer increases with N rate. $\varepsilon_{j, i}$ is a stochastic error term following a normal distribution and is spatially autocorrelated. The quadratic-plateau functional form implies a diminishing marginal product of N until a yield plateau, which is a desirable property for a yield response function [@frank1990comparison] and a pattern commonly observed in agronomic studies. Note that the cell-specific yield response function $f_{j, i} (N)$ is the reduced form of the meta response function $f$ when the characteristics vector takes on the value $\textbf{c}_{j, i}$. In other words, all the soil or field properties that could affect yield response to N are embedded in the simulated parameters.

The spatial distributions of cell-level parameters $\alpha_{j, i}$, $\beta_{j, i}$, $\gamma_{j,i}$, $\tau_{j, i}$, and the error term $\varepsilon_{j, i}$ were simulated by generating spatially correlated random fields using unconditional Gaussian geostatistical simulation based on the specified variograms [@dietrich1996fast; @wood1994simulation]. The simulation processes were conducted using the R package gstat [@graler16]. Specifically, the model is spherical, the nugget variance is zero, and the range is 600 meters. The nugget value of zero means that infinitesimally close observations have a zero covariance (i.e., they are identical). The range of 600m means that observations separated by more than 600m are spatially uncorrelated. A higher range value indicates increased spatial dependence, meaning that less abrupt differences tend to be observed between the production function parameters of neighboring cells. The choice of 600m range in this study was based on empirical data generated through eight on-farm randomized N field trials conducted by the Data-Intensive Farm Management Project (DIFM) project in 2018 [@bullock2019data]. The mean and sill variance of each parameter were specified to result in a realistic mean yield of $11,416$ kg ha$^{-1}$, and such that the cells' true economically optimal N rates ranged from $113$ kg ha$^{-1}$ to $273$ kg ha$^{-1}$ across all the simulations, a range into which most real-world N rate recommendations fall [e.g., @sawyer2018]. Note that the range of the optimal N rates of individual rounds of simulations are narrower. The magnitude of the error term $\varepsilon_{j, i}$ was also based on the DIFM project empirical data. Using the data from each of the eight actual trials, separate regressions of yield on N were run, and standard deviations of the residuals were calculated. The mean value of the eight standard deviations was $1370$ kg ha$^{-1}$, which was the square root value of the sill variances assigned to the simulations' error terms. Site-specific parameters and errors were generated for each of the 1,000 Monte Carlo iterations, resulting in distinct spatial patterns of EONR for each simulation instance. However, the parameters of the variogram (such as nugget and sill) remain consistent across simulations, ensuring that the spatial dependence of the site-specific parameters is the same.

## Trial Design

Figures \@ref(fig:field-layout) and \@ref(fig:field-N-design) illustrate the Latin square trial design assumed in each simulation. The field was partitioned into a 4-block $\times$ 2-block grid, in which each block was partitioned into a 6-plot $\times$ 6-plot grid with each of six N rates assigned to exactly one plot in each row and each column of the block (i.e., a Latin square). The design ensured that no adjacent N plots were assigned the same N rate. Furthermore, the order of N rates in each row of every block was specified to avoid relatively large changes in N rates (due to the technological limitations of N application equipment commonly witnessed in real-world OFPE).

Letting $p$ represent the crop price and $w$ represent the price of nitrogen fertilizer, in each simulation the "true" economically optimal N rate for each cell $(j, i)$ was calculated as

$$
N^*_{j,i} \equiv argmax_N \Big[p\cdot f_{j,i}(N)-w\cdot N\Big].
$$

In each simulation, six trial N rates were assigned by calculating the 0%, 20%, 40%, 60%, 80%, and 100% quantiles of the simulation's true cell-specific  critical N rates ($\tau_{j,i})$. The means of these trial N rates across simulations were approximately {80, 130, 154, 184, 219, and 270} kg ha$^{-1}$, while the differences between simulations were small and negligible.


## Yield Data Generation

In each simulation, for each cell $(j, i)$, the simulation's true yield $y_{j, i}$ was generated based on the cell's assigned application rate $N_{j,i}$, true response parameters $\textbf{c}_{j,i} = (\alpha_{j,i}, \beta_{j,i}, \gamma_{j,i}, \tau_{j,i})$, and error term $\varepsilon_{j,i}$. This procedure generated a field-level, cell-specific data set, $\{(y_{j, i},N_{j, i} ):j=1,\dots,1440;i=1,\dots, 6 \}$. To maintain consistency with real-world OFPEs, it was assumed that harvesting equipment could only record yields accurately at an 18m $\times$ 12m (subplot) resolution. Since every cell in a plot received the same N application rate, then so did every cell within a subplot, and therefore $N_{j,1} = N_{j,2}= \dots = N_{j,6} = N_j$ for each subplot $j$. Letting $\mu_j$ denote the mean of the yields of the cells in subplot $j$, the analysis of each round's data was based on 1440 $(\mu_j,N_j )$ observations.

## Estimation of Yield Response Functions and EONRs

Three approaches to estimating yield response functions and their associated EONRs were taken. The first approach used the shape-constrained additive model (SCAM) to estimate a single yield response function for the entire field, and with it estimate an economically optimal uniform nitrogen application rate for the field. The other two approaches both used GWR, but assumed different specifications in modeling the impact of nitrogen on yield. The first GWR approach (GWRR) followed the specification used by @rakshit2020, and the second GWR approach (GWRT) followed the specification used by @trevisan2021spatial. Further details of each approach are presented below. SCAM and GWR estimations were performed using $R$'s scam [@scam-R] and GWmodel [@gwmodel-R] packages.

### Spatially Uniform Management after Non-Spatial Regression Analysis of OFPE Data

In this scenario, a researcher was assumed to work with farmers to run OFPEs, gather data, and then to estimate a "full-field" uniform yield response function using the SCAM non-parametric regression framework [@pya2015shape]. SCAM is a type of generalized additive model (GAM) [@hastie1986gam] which allows for more flexible and nonlinear  relationships between the response variable and the predictors through a combination of smooth functions (also known as "splines"). In comparison to the conventional GAM technique, SCAM allows for the imposition of shape constraints on the estimated relationship, which is particularly useful when prior knowledge or theoretical considerations call for such shape restrictions of the relationship. In using SCAM in this study, the yield response function was restricted to be monotonically increasing and concave with respect to the N application rate, which are traits well substantiated by agronomic research [@cerrato1990comparison; @bullock1994quadratic]. When the chosen shape constraints are correct, SCAM is more statistically efficient than a fully non-parametric regression [@pya2015shape]. The estimated model is represented mathematically as follows,

$$y_j = \alpha + \sum_{k=1}^K \beta_k g_k(N_j)+ \varepsilon_j$$

where $g_k(\cdot)$ is the $k$th spline basis and $\beta_k$ is its coefficient to be estimated. The $\beta_k$s were constrained such that the resulting relationship between $y_j$ and $N_j$ is such that $y_j$ monotonically increases with $N_j$, but at a diminishing rate^[Please see @pya2015shape for technical details on how to implement this constraint under the GAM framework.].

Let $\hat{f}^{SCAM}(\cdot)$ represent the estimated whole-yield yield response function ($\hat{\alpha} + \sum_{k=1}^K \hat{\beta}_k g_k(\cdot)$). Given the information derived from the SCAM approach, the estimate of the economically optimal uniform N rate is,

$$\hat{N}^{*SCAM} \equiv argmax_N⁡ \big[p\cdot \hat{f}^{SCAM} (N)-w\cdot N\big].$$

### GWR-Rakshit (GWRR)

The GWRR model is simply the basic GWR model [@fotheringham1996geography; @brunsdon1999some; @fotheringham2003geographically], where subplot-specific yield responses were modeled as quadratic functions of the nitrogen rate. Each subplot $j \in {1, 2, \dots, 1440}$ was specified as,

$$y_j= \alpha_j+ \beta_j N_j + \eta_j N_j^2+ \varepsilon_j, \;\; j \in 1, 2, \dots, 1440.$$

The coefficients $\alpha_j$, $\beta_j$, and $\eta_j$ were continuous functions of subplot $j$'s coordinates ($lon_j$, $lat_j$). The GWRR estimation produced subplot-specific estimates of coefficients $\hat{\alpha}_j$, $\hat{\beta}_j$, and $\hat{\eta}_j$, and so of the yield response function $\hat{f}^{GWRR}_j(N)$ for $j = 1, 2, \dots, 1440$. The estimated economically optimal N application rate for subplot $j$ was calculated by solving the subplot's profit maximization problem,

$$\hat{N}^{*GWRR}_j \equiv argmax_N⁡[ p \cdot \hat{f}^{GWRR}_j (N) - w\cdot N], \;\; j \in 1, 2, \dots, 1440.$$

It should be noted that in some locations the estimated EONRs would be below or above the bound of trial N rates. For those locations, the minimum or maximum trial N rate was used as the corner solution of that location’s EONR. For example, if the estimated EONR was 40 kg/ha, the minimum trial N rate 80 kg/ha will be used as the EONR instead. 

### GWR-Trevisan (GWRT)

The GWRT model is also called the "mixed" GWR in the literature [@brunsdon1999some], where some parameters are fixed globally while others vary geographically. We estimated the coefficient on $N^2$ as a global parameter and the coefficient on $N$ subplot-specifically. For each subplot $j \in {1, 2, \dots, 1440}$, the assumed yield response was,

$$y_j= \alpha_j+ \beta_j N_j + \eta N_j^2+ \varepsilon_j ,$$

where $\eta$ was assumed invariant among subplots.

Let $\hat{f}^{GWRT}_j(N)$ for $j = 1, 2, \dots, 1440$ denote the estimated yield response function for subplot $j$. The estimated economically optimal N application rate for subplot $j$ was then,


$$\hat{N}^{*GWRT}_j \equiv argmax_N⁡[p\hat{f}^{GWRT}_j (N) -wN] .$$

The Gaussian kernel function was used when estimating both GWR models (other kernel functions were also tried and the final conclusions were quantitatively similar; see the supplemenraty appendix). There are several frequently used approaches in the literature to calculate the optimal kernal bandwidth, such as cross-validation [@cleveland1979robust; @bowman1984alternative] and the Akaike Information Criterion (AIC) [@akaike1973]. Like @rakshit2020 and @trevisan2021spatial, we followed the most recent GWR literature by using the corrected version of the AIC approach [@fotheringham2003geographically; @fotheringham2017multiscale; @lu2017geographically]. The optimal bandwidth differed slightly across each simulated experiment, and the average bandwidth was approximately 18 meters. 


## The value of GWR-based VRA over SCAM-based URA

To estimate the bias in the estimation of the economic value of GWR-based VRA, the true per-ha net revenues ("profits") of the SCAM-based URA and GWR-based VRA were calculated by substituting the estimated optimal nitrogen rates into the "true" yield response functions. Profits from the SCAM approach were:

$$\Pi^{SCAM} = \frac{1}{8640} \sum_{j=1}^{1440} \sum_{i=1}^6 \big[p \cdot f_{j, i} (\hat{N}^{*SCAM})-w \cdot \hat{N}^{*SCAM}\big]$$

and profits from the GWR approach (either GWRR or GWRT) were:

$$\Pi^{GWR}=\frac{1}{8640} \sum_{j=1}^{1440} \sum_{i=1}^6 [p \cdot f_{j, i} (\hat{N}^{*GWR}_j)-w \cdot \hat{N}^{*GWR}_j]$$

where $f_{j, i}(\cdot)$ denotes the true yield response function at cell $(j, i)$.

The true value of the GWR-based VRA compared to the SCAM-based URA is defined by the difference in their profits:

$$\Delta^{GWR} = \Pi^{GWR} - \Pi^{SCAM} .$$

To find the bias in estimating the value of VRA, the estimated profits of the SCAM-based URA and GWR-based VRA were calculated by substituting the estimated optimal nitrogen rates into the cell-specific yield response functions estimated by GWR:

$$\hat{\Pi}^{SCAM} = \frac{1}{8640} \sum_{j=1}^{1440} \sum_{i=1}^6 \big[p \cdot \hat{f}^{GWR}_{j, i} (\hat{N}^{*SCAM} )-w \cdot \hat{N}^{*SCAM}\big]$$

$$\hat{\Pi}^{GWR}=\frac{1}{8640} \sum_{j=1}^{1440} \sum_{i=1}^6 [p \cdot \hat{f}^{GWR}_{j, i} (\hat{N}^{*GWR}_{j} )-w \cdot \hat{N}^{*GWR}_{j}]$$
where $\hat{f}^{GWR}_{j, i}(\cdot) = \hat{f}^{GWR}_j(\cdot)$ denotes the estimated yield response function by GWR (either GWRR or GWRT) at cell $(j, i)$ within subplot $j$.

The estimated value of the GWR-based VRA compared to the SCAM-based URA is defined as:

$$\hat{\Delta}^{GWR} = \hat{\Pi}^{GWR} - \hat{\Pi}^{SCAM}.$$

Finally, the bias in the estimation of the value of GWR-based VRA was calculated as follows:

$$bias = \hat{\Delta}^{GWR} - \Delta^{GWR}.$$

# Results

## Comparing the values of GWR-based VRA and SCAM-based URA

Figure \@ref(fig:pi-dif-dist) shows the distribution of $\Delta^{GWR}$, the true profit difference between the GWR-based VRA and the SCAM-based URA, at three different price scenarios which represent the historically low (5.44), middle (6.56), and high (7.67) nitrogen-corn price ratio (\$/kg : \$/kg). Historical corn ($p$) and nitrogen fertilizer ($w$) prices from 2002 to 2022 were obtained from the USDA National Agricultural Statistics Service [@NASS2022] and DTN Retail Fertilizer Trends [@DTN2022], and were transformed into monthly data. The nitrogen-corn price ratios were calculated as $w/p$. Further information regarding the collection, calculation, and summary statistics of the price data can be found in the supplementary appendix (Appendix 1: Historical Corn and Nitrogen Prices).

The comparative advantage of GWRR and GWRT varies significantly depending on the nitrogen-corn price ratio. Specifically, GWRR performs better as nitrogen becomes more expensive relative to corn, while the opposite is the case for GWRT. At the low price ratio of 5.44, VRA based on GWRR is no better than SCAM-based URA. However, when the price ratio increases to $6.56$, the median benefit of GWRR is $`r round(mean_data_value[type == "GWRR" & pLabel == "Middle", pi_diff], digits = 2)` per hectare. At the high price ratio of 7.67, the median benefit is $`r round(mean_data_value[type == "GWRR" & pLabel == "High", pi_diff], digits = 2)` per hectare. On the other hand, the median benefit of VRA based on GWRT at the low price ratio of 5.44 is $`r round(mean_data_value[type == "GWRT" & pLabel == "Low", pi_diff], digits = 2)` per hectare, but the benefit is reduced to $`r round(mean_data_value[type == "GWRT" & pLabel == "Middle", pi_diff], digits = 2)` per hectare when the price ratio is 6.56, and $`r round(mean_data_value[type == "GWRT" & pLabel == "High", pi_diff], digits = 2)` per hectare when 7.67.  

Figure \@ref(fig:bias-est-eonr) provides insights into this phenomenon, showing the distribution of the average ratio of estimated EONR to true EONR. A value lower than 1 means that EONR is underestimated on average. GWRR tends to over-estimate EONR at lower price ratios, but the magnitude of over-estimation falls as the price ratio rises. The opposite trend is true for GWRT. At the high price ratio, the degree of EONR over-estimation is quite significant. Since a high-price ratio means nitrogen is relatively expensive, the economic cost of over-estimation of EONR increases with the price ratio.

To illustrate the difference in the GWRR and GWRT outcomes, Figure \@ref(fig:true-vs-estimated-optn-gwr-r) presents for a single simulation round the estimated site-specific EONR plotted against the true site-specific EONR. The site-specific EONR estimates are both inaccurate, but differently inaccurate. The range of EONR estimates by GWRR is very wide because the coefficient on $N^2$ is allowed to vary site specifically in GWRR. Since the estimation of the coefficient on $N^2$ is highly inaccurate, the range of estimated EONRs is much wider than the range of true site-specific EONRs. However, GWRT's range of EONR estimates is very narrow because the coefficient on $N^2$ is constrained to be equal across sites, making GWRT fail to capture the EONR's true spatial heterogeneity. 


## Bias in the estimation of the value of GWR-based VRA

Next, we examine the bias in the estimated value of GWR-based VRA. Figure \@ref(fig:bias-est-pi) shows the distribution of the bias in the estimation of the value of GWR-based VRA ($\hat{\Delta}^{GWR} - \Delta^{GWR}$). For example, the value of 10 would mean that the estimated value of GWR-based VRA over-estimates its true value by $10 per ha. As the figure shows, GWRR-based VRA appears to perform better than it truly does, presenting significant positive bias across the relative price range. That is, researchers would tend to significantly over-estimate the value of VRA based on GWRR. When the GWR estimates are considered to define true yield response, the inaccuracy of GWRR generates over-estimation of the heterogeneity of yield response within the field, which can lead to significant over-estimation of the value of GWRR itself. 

GWRT exhibits a different pattern of bias. At low price ratios, the GWRT approach displays smaller bias compared to GWRR. This is partially because GWRT tends to understate the heterogeneity of the site-specific yield response functions as was seen in Figure \@ref(fig:true-vs-estimated-optn-gwr-r). As the price ratio rises, bias increases. This is due to the significant over-estimation of EONR by GWRT, as illustrated by Figure \@ref(fig:bias-est-eonr). Unlike the GWRR approach, the distribution of the bias by the GWRT approach has a fat tail, indicating that there is a greater chance of encountering large positive bias in the estimated value of VRA over URA.

Figure \@ref(fig:why-bias-many) illustrates how over-estimation of the value of VRA can occur. It shows yield response functions estimated by GWRT and estimated yields associated with the GWR-based EONR rates and SCAM-based EONR rates for 50 randomly chosen cells in a single simulation. Since GWR-based EONRs were obtained assuming the yield response functions estimated by GWR, by construction they out-perform the SCAM-based estimates in every cell. For many cells, the SCAM-based estimated EONR is significantly higher than the actual yield-maximizing N rate, resulting in an estimated yield far lower because of the quadratic functional form assumption. Figure \@ref(fig:why-bias-single) focuses on a single cell and compares estimated and true yields between GWR and SCAM (panel (a)) and estimated and true profits between GWR and SCAM (panel (b)). The cell's true yield response functions plateaus at a nitrogen rate of about $`r round(il_data_oe[aunit_id %in% single_aunit, Nk], digits = 0)`$ kg ha$^{-1}$, but the GWR-estimated yield response function suggests that yield should peak at a nitrogen rate of about $`r round(point_data_gwr[type == "GWR", N], digits = 0)`$ kg ha$^{-1}$ and decline thereafter. In reality, the yield differential between GWR and SCAM is 0, while the estimated yield differential is about `r round(point_data_gwr[type == "GWR", yield] - point_data_gwr[type == "SCAM", yield], digits = 2)` ton ha$^{-1}$, leading to the over-estimation of the value of GWR in panel (b). Based on the true profit response curve, applying the GWR-based recommendation is about \$`r round(true_yield_data[type != "True", diff(profit)], digits = 0)` ha$^{-1}$ "less" profitable than applying the SCAM-based recommendation. This profit differential comes solely from the difference in nitrogen cost since GWR and SCAM yields are equal. However, if calculations are based on the cell's GWR-based estimation of the response function, profits from the GWR-based recommendation are measured to exceed those from the SCAM-based recommendation by about \$`r round(- point_data_gwr[, diff(profit)], digits = 0)` ha$^{-1}$. Beyond the difference in nitrogen cost, the falsely estimated yield boost by GWR contributes to the profit differential, thus significantly over-estimating the actual value of GWR. 

# Discussion and Conclusions

Our simulation results show that generating site-specific $R_x$s by applying the basic GWR model (GWRR) with a quadratic functional form to OFPE data tends to have little economic value for site-specific $R_x$s when the true yield response function is quadratic-plateau. The GWRR based VRA is on average no more profitable than SCAM-based URA under many price scenarios, particularly when nitrogen price is relatively low compared to the corn price. This finding reveals the economic consequences of the widely recognized statistical inaccuracy issue of GWR estimation [@griffith2008spatial; @paez2011simulation; @da2016multiple; @harris2019simulation] and also the problem of assuming quadratic functional form when the true yield response function follows the quadratic-plateau functional form, such as in the corn-nitrogen relationship. Precision agriculture practitioners should be cautious when using GWR for site-specific $R_x$s. If the GWR-based approach must be employed to find site-specific input recommendations (e.g., due to lack of field and soil information), our simulation results show that GWRT performs relatively better than GWRR, though its profitability improvement against URA is only moderate. 

Previous studies comparing models have predominantly focused on measuring model performance based on statistical accuracy of parameter estimates, such as bias, mean squared error, type I error, and confidence intervals, for both GWR models [@lu2017geographically; @harris2019simulation] and general econometric models [@christopeit2006local; @su2016identifying]. While these statistical measures are fundamental for evaluating model performance, for practical reasons it is imperative to consider the translation of statistical accuracy into economic value. Moreover, the extent of this translation could vary depending on the specific application scenarios. The research reported in the present article distinguishes itself from previous literature by explicitly examining the economic value of specific econometric models (GWR) under a model functional form misspecification (quadratic instead of quadratic-plateau), in a specific application (corn site-specific nitrogen management), and under specific context scenarios (normal-sized production field, various market prices, etc.), through a simulation-based methodology. We encourage other model comparison studies in empirical economic research to also incorporate similar assessment of economic value.

Our results clearly show that it can be problematic to use GWR under the assumption of a quadratic functional form when the true yield-input relationship is quadratic-plateau. @trevisan2021spatial had to choose the quadratic functional form because no readily usable statistical software or package could be used to implement nonlinear GWR. The only nonlinear model available at the moment is the linear-plateau GWR by @lambert2022geographically. Unfortunately, the estimation of the economically optimal input rate cannot be adjusted according to price using the linear-plateau model as the economically optimal input rate occurs always at the kink (critical input rate where yield plateau is reached). Given that many yield-input relationships follow quadratic-plateau functional form for many crops, it would be fruitful to develop a GWR method with quadratic-plateau functional form. It should be also possible and interesting to build semi-parametric GWR where the yield response functions are estimated without assuming particular functional forms (like SCAM). It is also noted that the recently developed multi-scale GWR model [@fotheringham2017multiscale; @yu2020inference; @comber2022route] allows the bandwidth to be derived separately for each covariate in the model, which would potentially improve the performances of GWR estimates and may need to be incorporated into future research. Note, however, that multi-scale GWR models are not necessary in our simulations as we have only one covariate ($N$) in our simulations.

Most importantly, whether using GWRT or GWRR, researchers must be cautious about their estimated values of VRA when the model is assumed to be quadratic but the true underlying yield-input response is quadratic-plateau in reality. Our results show that it is likely that they will over-estimate their true values and the bias can be misleadingly high with non-negligible probability. The extremely high values of VRA reported in @trevisan2021spatial are likely to have reflected this bias. Indeed, the bias problem we have raised here is likely to be observed for other statistical methods as well because the bias comes from the assumption that the _estimated_ yield response functions are true. Whatever the underlying statistical methods for yield response functions may be, researchers are likely to overestimate the true value of their methods. It would be an interesting future research to investigate the bias in other commonly used statistical methods in the literature on site-specific yield response estimation (such as regression with interaction terms of field characteristics, machine learning, and more) by using a similar simulation-based evaluation approach as done in this study. 

<!-- # Conclusions

This article examined the economic value of GWR-based VRA and the bias in its estimation in the context of OFPE. We showed that VRA based on GWR provides only small economic benefits over URA based on SCAM. The relative performances of the model specifications used by @trevisan2021spatial and @rakshit2020 differs based on nitrogen-corn price ratio. Finally and most important, we found that both specifications can result in significant over-estimation of the true value of GWR-based site-specific nitrogen rate recommendations. It can be concluded that researchers need to be cautious about promoting the GWR-based approach to VRA recommendation. -->

`r run_pagebreak()`

# Figures

```{r fig.id = "field-layout", fig.cap = "Simulated field layout with spatial unit definitions", fig.width = 7}
# knitr::include_graphics(here::here("GitControlled/Writing/Figures/g_layout.png"))
g_layout
```

```{r fig.id = "field-N-design", fig.cap = "Experiment design of nitrogen (N) rates", out.width = "6in", fig.width = 6}
# knitr::include_graphics(here::here("GitControlled/Writing/Figures/g_exp.png"))
g_exp
```

```{r, fig.id = "pi-dif-dist", fig.cap = "The true economic value of GWR-based VRA over SCAM-based URA by two GWR models (GWRR and GWRT) and at three nitrogen-corn price ratios", out.width = "6.5in", fig.width = 6}
# knitr::include_graphics(here::here("GitControlled/Writing/Figures/g_value.png"))
g_value
```

```{r fig.id = "bias-est-eonr", fig.cap = "Average bias in the estimation of EONR by two GWR models (GWRR and GWRT) and at three nitrogen-corn price ratios", fig.width = 6}
# knitr::include_graphics(here::here("GitControlled/Writing/Figures/g_eonr_bias.png"))
g_eonr_bias
```

```{r fig.id = "true-vs-estimated-optn-gwr-r", fig.cap = "Comparison of GWR-Estimated and True EONR at the middle price ratio of 6.56", fig.width = 6}
# knitr::include_graphics(here::here("GitControlled/Writing/Figures/g_comp_eonr.png"))
g_comp_eonr
```

```{r fig.id = "bias-est-pi", fig.cap = "Bias in the estimation of the value of GWR-based VRA over SCAM-based URA by two GWR models (GWRR and GWRT) and at three nitrogen-corn price ratios", fig.width = 6}
# knitr::include_graphics(here::here("GitControlled/Writing/Figures/g_bias.png"))
g_bias
```

```{r fig.id = "why-bias-many", fig.cap = "The cause of significant over-estimation of the value of GWR-based VRA", fig.width = 6}
# knitr::include_graphics(here::here("GitControlled/Writing/Figures/g_why_bias_many.png"))
g_why_bias_many
```

```{r fig.id = "why-bias-single", fig.cap = "An illustration of over-estimation of the value of GWR-based VRA over SCAM-based URA",fig.width = 6.5, fig.height = 6}
# knitr::include_graphics(here::here("GitControlled/Writing/Figures/g_why_bias_single.png"))
g_why_bias_single
```

`r run_pagebreak()`

# References

<br />

<div id="refs"></div>

`r run_pagebreak()`


# Conceptual Framework: Estimation of Yield-to-input Response Relationships Using OFPE Data

OFPE can provide detailed as-applied input and yield data at dense resolutions over entire fields, which if well analyzed may provide valuable information that can improve site-specific input application recommendations [@bullock2019data; @lacoste2021farm]. Consider a yield response function $y = f(\textbf{x}, \textbf{c})$, where following @bullock2000agronomic, $\textbf{x}$ is a vector of input management variables and $\textbf{c}$ is a vector of spatial variables describing field and soil characteristics^[For simplicity, we suppress discussion of the need to bring variance in weather data into yield response estimation.  Obviously, generation and use of weather data is necessary to provide meaningful probabilistic analysis and input management advice.]. Letting a field site $i$ be defined as a contiguous area characterized uniformly by a value $\textbf{c}_i$ of the vector of field and soil characteristics, its *site-specific yield response function* is the reduced form of the field's yield response function created when the value of the vector of characteristics variables is set at the site's value, $\textbf{c}_i$:  $f_i(\textbf{x}) \equiv f(\textbf{x}, \textbf{c}_i)$.  This conceptualization suggests two methods of estimating a field's site-specific yield responses. The first is to estimate a "map" of the field characteristics, for example thought of as a set of the field's $n \geq 1$ sites' values of the characteristics vector: $\{\textbf{c}_1,\dots, \textbf{c}_n\}$.  With that map, regressing yield on $\textbf{x}$ and $\textbf{c}$ generates an estimated "field-specific" yield response function $\hat{f}(\textbf{x},\textbf{c})$. Estimates of site-specific yield response functions can then be obtained by inserting the value of the site's characteristic variables into the estimate of the field-specific response function: $\hat{f}_i(\textbf{x}) \equiv \hat{f}(\textbf{x},\textbf{c}_i)$. Alternatively, a site-specific yield response function might be estimated simply by taking (input rate, yield) data from points around a site of interest $i$, and regressing yield on input application rates to attain the estimate $\hat{f}_i (\textbf{x})$. Stated roughly, using GWR takes the latter approach, which has the advantage of not needing a costly map of field characteristics values.