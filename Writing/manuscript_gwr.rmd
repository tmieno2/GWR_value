---
title: "Economic Evaluation of Geographically Weighted Regression Analysis for Site-specific Nitrogen Management"
author:
  - Taro Mieno^[University of Nebraska Lincoln, tmieno2@unl.edu], Xiaofei Li^[Mississippi State University, xiaofei.li@msstate.edu], David S. Bullock^[University of Illinois, dsbulloc@illinois.edu]
output:
  officedown::rdocx_document:
    toc: false
    toc_depth: 1
    number_sections: true
    reference_docx: "word_template.docx"
    plots:
      style: Normal
      align: center
      caption:
       style: Image Caption
       pre: "Figure "
       sep: ": "
    tables:
      style: Table
      layout: autofit
      width: 1.0
      caption:
       style: Table Caption
       pre: "Table "
       sep: ": "
bibliography: PA.bib
csl: field-crops-research.csl
abstract: ""
---

```{r echo = F, cache = F}
suppressMessages(library(knitr))
suppressMessages(library(here))
suppressMessages(library(officedown))
suppressMessages(library(officer))

opts_chunk$set(
  fig.align = "center",
  fig.retina = 5,
  warning = F,
  message = F,
  cache = F,
  echo = F,
  fig.cap = TRUE
)
```

```{r cache = F}
#--- packages ---#
library(data.table)
library(tidyverse)
library(flextable)
library(stringr)
library(sf)
library(lfe)
library(modelsummary)
library(patchwork)
library(ggplot2)
```

```{r figure_setup, cache = F}
theme_update(
  axis.title.x =
    element_text(
      size = 12, angle = 0, hjust = .5, vjust = -0.3, family = "Times"
    ),
  axis.title.y =
    element_text(
      size = 12, angle = 90, hjust = .5, vjust = .9, family = "Times"
    ),
  axis.text.x =
    element_text(
      size = 10, angle = 0, hjust = .5, vjust = 1.5, family = "Times"
    ),
  axis.text.y =
    element_text(
      size = 10, angle = 0, hjust = 1, vjust = 0, family = "Times"
    ),
  axis.ticks =
    element_line(
      size = 0.3, linetype = "solid"
    ),
  axis.ticks.length = unit(.15, "cm"),
  #--- legend ---#
  legend.text =
    element_text(
      size = 10, angle = 0, hjust = 0, vjust = 0, family = "Times"
    ),
  legend.title =
    element_text(
      size = 10, angle = 0, hjust = 0, vjust = 0, family = "Times"
    ),
  legend.key.size = unit(0.5, "cm"),
  #--- strip (for faceting) ---#
  strip.text = element_text(size = 10),
  #--- plot title ---#
  plot.title = element_text(family = "Times", face = "bold", size = 12),
  #--- margin ---#
  # plot.margin = margin(0, 0, 0, 0, "cm"),
  #--- panel ---#
  panel.grid.major = element_blank(),
  panel.grid.minor = element_blank(),
  panel.background = element_blank(),
  panel.border = element_rect(fill = NA)
)
```

```{r include = FALSE}
#| include: false

# /*===========================================================
#' # Prepare data and results for writing
# /*===========================================================
#* source all the functions in the Functions folder
fs::dir_ls(here("GitControlled", "Codes", "Functions"), full.names = TRUE) %>%
  lapply(., function(x) source(x))

#* read the results rds file
results <-
  here("Shared", "Results", "pi_data.rds") %>%
  readRDS() %>%
  .[, type := ifelse(transfer == 0, "GWR-R", "GWR-T")] %>%
  .[, bias := pi_diff_est - pi_diff] %>%
  # only display the 25% (5.44), 50% (6.56), 75% (7.67) price ratio
  .[pRatio %in% c(5.44, 6.56, 7.67), ] %>%
  # === label price ratio
  .[, pLabelName := "Price Ratio (N/corn)"] %>%
  .[pRatio == 5.44, pLabel := "Low"] %>%
  .[pRatio == 6.56, pLabel := "Middle"] %>%
  .[pRatio == 7.67, pLabel := "High"] %>%
  .[, pLabel := factor(pLabel, levels = c("Low", "Middle", "High"))]

#* create figures
source(here("GitControlled/Codes/3_make_figures_publication.R"))
```

**Abstract**: Geographically weighted regression (GWR) has been presented as a prominent tool to estimate site-specific yield response functions to derive site-specific input rate recommendations from data generated by on-farm precision experimentation (OFPE). The key objectives of this paper are two-fold. The first objective is to evaluate economically the two sets of functional-form specifications used by two recent published studies of site-specific input management that apply GWR to data from OFPE. We show that the relative performance of the two approaches vary depending on the crop-fertilizer price ratios due to their tendency to over-/under-estimate EONR. The second and more important, we investigate the possibility of bias in estimating the economic value of site-specific recommendation maps based on GWR. We show that both GWR approaches suffer significant positive bias, which can lead to large over-estimation of the economic value of applying GWR methods. Our study is the first to systematically examine the economic (not statistical) properties of the use of GWR in OPFE settings. We reveal that in many circumstances using GWR is far less profitable than claimed by previous studies, which provides a necessary cautionary message to researchers who might otherwise “over-sell” to other researchers the value of using GWR methods in empirical work involving the estimation of site-specific input management.
 
**Keywords**: on-farm precision experimentation, site-specific input management, geographically weighted regression, economically optimal nitrogen rate

**Acknowledgements**: This research was supported by a USDA-NIFA-AFRI Food Security Program Coordinated Agricultural Project, titled “Using Precision Technology in On-farm Field Trials to Enable Data-Intensive Fertilizer Management,” (Accession Number 2016-68004-24769), and also by the a USDA-NRCS Conservation Innovation Grant from the On-farm Trials Program, titled “Improving the Economic and Ecological Sustainability of US Crop Production through On-Farm Precision Experimentation” (Award Number NR213A7500013G021), and by USDA NIFA's Hatch Project 470-362.

`r run_pagebreak()`

# Introduction

In recent years, on-farm precision experimentation (OFPE) has gained traction with both researchers and practitioners as a means of generating high-resolution spatial data to inform site-specific crop input management decisions [@bullock2019data; @lacoste2021farm]. Accompanying interest is surging among researchers in identifying efficient statistical methods to estimate site-specific yield response functions, which have examined various methods, ranging from Geographically Weighted Regression (GWR) [@rakshit2020; @evans2020assessment; @trevisan2021spatial] to machine learning methods, including the random forest [@krause2020random], convolutional neural network [@barbosa2020modeling], and causal forest [@kakimoto2022causal] approaches. Among these methods applied to OFPE data, GWR is distinct in that it does not require potentially costly collection of site-specific field and soil information in estimating site-specific yield response functions.

On any given field, it is typical for U.S. Midwestern row crop farmers to pay for 1-ha grid soil sampling and chemical analysis every three or four years [@morris2018strengths]. The data is often used to derive fertilizer application recommendations, for example by applying comparatively simple formulas provided by university extension services (e.g., Culman, et al. 2020). But the expense of soil sampling and analysis is driving development of sensor technologies that gather data on site-specific field and crop characteristics or proxies of those characteristics. For example, Trimble Agriculture's GreenSeeker and AgLeader's OptRx® systems use optical sensors mounted on fertilizer application booms to digitally record vegetative index imagery as farm machinery is driven through fields during early crop growth stages. GreenSeeker then basically uses Oklahoma State University's Sensor-based N Rate Calculator to convert those data into recommended nitrogen fertilizer (N) application rate maps ($R_xs$). Veris Technologies manufactures sensor equipment that can be towed through fields to gather apparent electroconductivity (EC) data, which can be used to infer properties of soil content. The "decision tool" software FieldRevealTM allows users to upload EC data, elevation data, and vegetative index data, which FieldRevealTM's professional agronomists analyze to provide $R_x$s to farmers. FieldApex creates N $R_x$s using foliar vegetative index data from satellite imagery, and SlantRange uses drone imagery for similar purposes.


However, deploying sophisticated sensors to gather field characteristics data is also costly, and the effects of their generation and use on farming profitability remains in question [@gardner2021economic]. Recognizing the significant costs of obtaining useful, high-resolution soil and field properties data, @trevisan2021spatial demonstrated a method of providing site-specific management recommendations without such data. They estimated site-specific yield response functions by applying GWR techniques on data from OFPEs [@bullock2019data], and reported dramatic results, estimating an average potential gain of \$65 ha$^{-1}$ from applying seed and N at optimal uniform rates (instead of at the rates the farmers would have chosen if not participating in the research), and an additional potential gain of \$58 ha$^{-1}$ when changing from optimal uniform application rates to optimal site-specific application rates. This is rather surprising given the often-reported poor statistical accuracy of GWR estimates [@griffith2008spatial; @paez2011simulation; @da2016multiple; @harris2019simulation]. @rakshit2020 also applied GWR to on-farm experiment data. However, while they did estimate site-specific yield response functions, they did not derive site-specific economically optimal nitrogen rates based on them, and thus did not conduct economic analysis, unlike @trevisan2021spatial. @evans2020assessment explored using GWR with a linear model specification to detect low- and high-response areas, but like @rakshit2020, they also did not estimate site-specific economically optimal nitrogen rates.

This study has two key objectives. The first is to determine which of the model specifications used by @rakshit2020 and @trevisan2021spatial result in more profitable $R_xs$. While both @rakshit2020 and @trevisan2021spatial proposed using GWR to estimate site-specific yield response functions, they used different model specifications. Both assumed a quadratic response of yield to nitrogen rate ($N$). However, while @trevisan2021spatial estimated the coefficient on $N^2$ as a global parameter, @rakshit2020 estimated it locally for each point. At first, it appears that the specification used by @rakshit2020 is superior since it is more flexible than the specification used by @trevisan2021spatial. However, the flexibility can be a disadvantage rather than an advantage because the estimation of EONR is highly sensitive to the coefficient estimates on $N^2$, and GWR often provides inaccurate local estimation of that coefficient. 

Second, we will examine the degree and direction of bias in the estimation of the economic value of GWR-based variable rate application (VRA) and question the extremely high estimates of that value reported by @trevisan2021spatial. It is critical to keep in mind that it is not our objective to measure the bias in the coefficient estimation by GWR, unlike [@griffith2008spatial; @paez2011simulation; @da2016multiple; @harris2019simulation]. Rather, we are interested in the economic implications of the statistical inaccuracy in estimating the coefficients of the model in this study. In general, researchers take the following steps to estimate the value of VRA using OFPE data [e.g., @anselin2004spatial; @swinton1998evaluating; @bullock2002adding; @liu2006site]: (1) estimate site-specific yield response functions based on a method chosen by the researcher; (2) use the estimated yield response functions to estimate the economically optimal site-specific input rates (EOIRs) and economically optimal uniform input rates; (3) plug the estimated site-specific EOIRs and uniform EOIR into the estimated yield response functions to calculate estimated profits under both strategies; and (4) find the difference in the two strategies' estimated profits. However, this approach can result in significant bias in the estimation of the value of VRA because of the step 3's assumption that the estimated yield response functions are the true yield response functions. @trevisan2021spatial provided an example at step (3) by assuming that their GWR estimates provided "true" site-specific yield response functions. This assumption is generally unavoidable for researchers since they cannot observe any real field's true site-specific yield response functions. But, inaccurate estimation in this methodology can result in significant bias in the estimation of the value of VRA. This bias problem can be particularly severe when the method used tends to exaggerate the true heterogeneity in yield response functions. We suspect that the high value of VRA estimated by @trevisan2021spatial displays this bias.

In the following, we pursue the two objectives by conducting Monte Carlo simulations in which we first generate and then analyze stylized OFPE data. We cannot test which model specification results in more profitable site-specific nitrogen rate recommendations using real data because it is impossible to observe the true yield response functions using real-world data. For the same reason, we cannot test whether @trevisan2021spatial over-estimates the actual value of VRA, either. But in the Monte Carlo simulations we specify yield response functions and generate stylized data from those functions, which enables us to quantify in the context of the simulations the value of GWR and the bias in GWR-based estimation of the value of VRA. Monte Carlo simulations are commonly used in this way to gain insights into the statistical and economic properties of trial designs and estimations methods [@mckinion2001analysis; @gebbers2010application; @bullock2020value; @alesso2021design].

One of the principal findings of this article is that the model specification used by @trevisan2021spatial tends to outperforms that by @rakshit2020 when the ratio of nitrogen price to corn price is low (nitrogen is relatively cheap), but the relationship reverses when the price ratio is high. This is due the tendency of the specification by @trevisan2021spatial and @rakshit2020 to over- and under-estimate EONR, respectively. We also show that the benefit of VRA over URA is rather small irrespective of the specification used, averaging only about \$5 ha$^{-1}$; we conclude that both @rakshit2020 and @trevisan2021spatial may have significantly over-estimated that value. Our results suggest that the prospects of using GWR to generate site-specific input recommendations are bleaker than stated in @trevisan2021spatial.

<span style = "color: blue;"> this needs to be rewritten </span>

# Materials and Methods

## Experimental Field Layout

Figure \@ref(fig:field-layout) shows the simulated field's layout and defines the spatial units of the simulated on-farm precision experiments in this study. The basic spatial unit of the field is a 6m $\times$ 6m "cell", which is the resolution at which the field characteristics data (i.e., parameters of the "true" yield response function) were allowed to vary. It was assumed, however, that yields could not be monitored at such a high resolution. Rather, the mechanical harvester was assumed to be 18m wide, and, in cases in which the N rate was unchanged, in need of harvesting on a run of no less than 12m to provide accurate yield data. Therefore, the yield data's resolution was 18m $\times$ 12m (3 cells $\times$ 2 cells, called a "subplot"). The N rate unit consisted of five "subplots", that is, 18m $\times$ 72m (3 cells $\times$ 12 cells, called a "plot") to accommodate the variable-rate applicator's application resolution. A 12m "transition zone" was placed between two plots (that is, a 6m "transition zone" on each end of a plot), so that when the experimental N rate changed, the harvester had 12 m to "clear" and begin to record accurately on a plot with an N rate different from its predecessor's.

The field was 432m (72 cells) wide and 864m (144 cells) long, making its area 37.3 ha. Data from the 6-m-wide headlands, side-lands (there are no transition zones on the north and south ends of the field), and 12-m-wide "transition zones" were not included in the data analyzed. In total there were 1440 subplots available for experimental data analysis. The index $j \in {1, 2, \dots, 1440}$ identifies the field's subplots, and the index $k \in {1, \dots , 6}$ identifies the cells within a subplot. The couplet $(j, k)$ is used to identify individual cells.

## True Cell-specific Yield Response Function

An extensive literature examines the choice of functional form in yield response estimation [@cerrato1990comparison, @frank1990comparison, @bullock1994quadratic, @tembo2008crop]. Out simulation assume that each cell $(j, k)$'s "true" yield response function is assumed to follows the commonly-used quadratic-plateau functional form:

$$
\begin{equation} \tag{1}
y_{j,k} = f_{j, k} (N) = f(N, c_{j,k}) = 
  \begin{cases}
  \alpha_{j,k} + \beta_{j,k} N + \gamma_{j,k} N^2 + \varepsilon_{j,k} \, ,& N < \tau_{j,k} \\
  \alpha_{j,k} + \beta_{j,k} \tau_{j,k} + \gamma_{j,k} \tau_{j,k}^2 + \varepsilon_{j,k} \, ,& N \ge \tau_{j,k}
  \end{cases}
\end{equation}
$$

where $c_{j,k} = (\alpha_{j,k},\beta_{j,k},\gamma_{j,k},\tau_{j,k})$ is the vector of yield response function parameters. $\tau_{j,k}$ can be interpreted as the critical value of N rate at which cell $(j, k)$'s yield reaches its plateau, where yield no longer increases with N rate. $\varepsilon_{j, k}$ is a stochastic error term. The quadratic-plateau functional form implies a diminishing marginal product of N until a yield plateau, which are desirable properties for a yield response function [@frank1990comparison] and a pattern commonly observed in agronomic studies. Note that the cell-specific yield response function $f_{j, k} (N)$ is the reduced form of the meta response function $f$ when the characteristics vector takes on the value $c_{j, k}$. In other words, all the soil or field properties that could affect yield response to N are embedded in the simulated parameters.

The spatial distributions of cell-level parameters $\alpha_{j, k}$, $\beta_{j, k}$, $\gamma_{j,k}$, $\tau_{j, k}$, and the error term $\varepsilon_{j, k}$ were simulated by generating spatially correlated random fields using unconditional Gaussian geostatistical simulation based on the specified variograms [@dietrich1996fast, @wood1994simulation], and the simulation processes were conducted using the R package gstat [@graler16]. Specifically, the model is spherical, the nugget variance is zero, and the range is 600 meters. The nugget value of zero means that infinitesimally close observations have a zero covariance (i.e., they are identical). The range of 600m means that observations separated by more than 600m are spatially uncorrelated. A higher range value indicates increased spatial dependence, meaning less abrupt differences are observed between the production function parameters of neighboring cells. The mean and sill variance of each parameter were specified to result in a realistic mean yield of $11,416$ kg ha$^{-1}$, and such that the cells' true economically optimal N rate ranged from $113$ kg ha$^{-1}$ to $273$ kg ha$^{-1}$ among all the simulations, a range into which most real-world N rate recommendations fall [e.g., @sawyer2018]. Note that the range of the optimal N rates of individual rounds of simulations are narrower. In defining the magnitude of the error term, we utilized the experimental data generated through eight on-farm randomized N field trials conducted by the DIFM project in 2018 by the Data-Intensive Farm Management Project (DIFM), [@bullock2019data]. Using the data from each of the eight actual trials, separate regressions of yield on N were run, and standard deviations of the residuals were calculated. The mean value of the eight standard deviations was $1370$ kg ha$^{-1}$, which was the value of sill variances assigned to the simulations' error terms.

## Trial Design

Figures \@ref(fig:field-layout) and \@ref(fig:field-N-design) illustrate the Latin square trial design schema assumed in each simulation. The field was partitioned into a 4-block $\times$ 2-block grid, in which each block was partitioned into a 6-plot $\times$ 6-plot grid with each of six N rates assigned to exactly one plot in each row and each column of the block. The design ensured that no adjacent N plots were assigned the same N rate. Furthermore, the order of N rates in each row of every block was specified to avoid relatively large changes in N rates (due the technological limitations of N application equipment commonly witnessed in real-world OFPE).

Letting $p$ represent the crop price and $w$ represent the price of nitrogen fertilizer, in each simulation the "true" economically optimal N rate for each cell $(j, k)$ was calculated as

$$
N^*_{j,k} \equiv argmax_N \Big[p\cdot f_{j,k}(N)-w\cdot N\Big].
$$

In each simulation, six trial N rates were assigned by calculating the 0%, 20%, 40%, 60%, 80%, and 100% quantiles of the simulation's true cell-specific optimal N rates. When using the historical average corn and N prices (past 20 years, 2002-2021), the means of these trial N rates across simulations were approximately, {80, 130, 154, 184, 219, and 270} kg ha$^{-1}$.

## Yield Data Generation

In each simulation, for each cell $(j, k)$, the simulation's true yield $y_{j, k}$ was generated based on the cell's assigned application rate $N_{j,k}$, true response parameters $c_{j,k} = (\alpha_{j,k}, \beta_{j,k}, \gamma_{j,k}, \tau_{j,k})$, and error term $\varepsilon\_{j,k}$. This procedure generated a field-level, cell-specific data set, $\{(y_{j, k},N_{j, k} ):j=1,\dots,1440;k=1,\dots, 6 \}$. To maintain consistency with real-world OFPEs, it was assumed that harvesting equipment could only record yields accurately at an 18m $\times$ 12m (subplot) resolution. Since every cell in a plot received the same N application rate, then so did every cell within a subplot, so $N_{j,1} = N_{j,2}= \dots = N_{j,6} = N_j$ for each subplot $j$. Letting $\mu_j$ denote the mean of the yields of the cells in subplot $j$, the analysis of each round's data was based on 1440 $(\mu_j,N_j )$ observations.

## Estimation of Yield Response Function and EONR

Three approaches to estimate yield response functions and their associated EONRs were used. The first approach used the shape-constrained additive model (SCAM) to estimate a single yield response function for the entire field, and to estimate and economically optimal uniform nitrogen application rate for the field. The other two approaches both used GWR, but assumed different specifications in modeling the impact of nitrogen on yield. The first GWR approach (GWR-R) followed the specification used by @rakshit2020, and the second GWR approach (GWR-T) followed the specification used by @trevisan2021spatial. Further details of each approach are presented below. SCAM and GWR estimations were performed using $R$'s scam [@scam-R] and GWmodel [@gwmodel-R] packages.

### Spatially Uniform Management after Non-Spatial Regression Analysis of OFPE Data

In the lower benchmark situation, a researcher was assumed to run OFPEs to gather data, then to estimate a single "full-field" yield response function using the SCAM non-parametric regression framework, which is a spline-based series estimation that can impose a shape-constraints on the estimated function [@pya2015shape]. In using SCAM, the yield response function was restricted to be monotonically increasing and concave with respect to the N application rate, which are traits well substantiated by agronomic research. When the chosen shape constraints are correct, SCAM is more statistically efficient than a fully non-parametric regression [@pya2015shape]. The estimated model is represented mathematically as follows,

$$y_j = \alpha + \sum_{l=1}^l \beta_l g_l(N_j)+ \varepsilon_j$$

where $g_l(\cdot)$ is the $l$th spline basis and $\beta_l$ is its coefficient to be estimated. The $\beta_l$s were constrained such that the resulting relationship between $y_j$ and $N_j$ is such that $y_j$ monotonically increases as $N_j$ increases, but at a diminishing rate.

Let $\hat{f}_{scam}(\cdot)$ represent the estimated whole-yield yield response function ($\sum_{k=1}^K \hat{\beta}_k g_k(\cdot)$). Given the information derived from the SCAM approach, the estimate of the economically optimal uniform N rate is,

$$\hat{N}_{scam}^* \equiv argmax_N⁡ \big[p\cdot \hat{f}_{scam} (N)-w\cdot N\big]$$

### GWR-Rakshit (GWR-R)

The GWR-R model is simply the basic GWR model [@fotheringham1996geography; @brunsdon1999some; @fotheringham2003geographically], where subplot-specific yield responses were modeled as quadratic functions of the nitrogen rate, which for each subplot $j \in {1, 2, \dots, 1440}$ was specified as,

$$y_j= \alpha_j+ \beta_j N_j + \eta_j N_j^2+ \epsilon_j, \;\; j \in 1, 2, \dots, 1440.$$

The coefficients $\alpha_j$, $\beta_j$, and $\eta_j$ were continuous functions of subplot $j$’s coordinates ($lon_j$, $lat_j$). The GWR-R estimation produced subplot-specific estimates of coefficients $\hat{\alpha}_j$, $\hat{\beta}_j$, and $\hat{\eta}_j$, and so of the yield response function $\hat{f}_{gwr-r,j}(N)$ for $j = 1, 2, \dots, 1440$. The estimated economically optimal N application rate for subplot $j$ was calculated by solving the subplot's profit maximization problem:

$$\hat{N}_{gwr-r,j}^{*} \equiv argmax_N⁡[p\hat{f}_{gwr-r, j} (N) -wN], \;\; j \in 1, 2, \dots, 1440.$$

### GWR-Trevisan (GWR-T)

The GWR-T model is also called as “mixed” GWR in the literature [@brunsdon1999some], where some parameters are fixed globally while others vary geographically. In our model, the coefficient on $N^2$ was estimated as a global parameter while the coefficient on $N$ was estimated subplot-specifically. For each subplot $j \in {1, 2, \dots, 1440}$, the assumed yield response was,

$$y_j= \alpha_j+ \beta N_j + \eta N_j^2+ \epsilon_j ,$$

where $\eta$ was assumed invariant among subplots.

Let $\hat{f}_{gwr-t,j}(N)$ for $j = 1, 2, \dots, 1440$ denote the estimated yield response function for subplot $j$. The estimated economically optimal N application rate for subplot $j$ was then,

$$\hat{N}^*_{gwr-t,j} \equiv argmax_N⁡[p\hat{f}_{gwr-t,j} (N) -wN] .$$

The Gaussian kernel function was used when estimating both GWR models, and the optimal bandwidth was selected through the corrected AIC approach [@fotheringham2003geographically]. The optimal bandwidth differed slightly across each simulated experiment, and the average bandwidth was around 18 meters. 

## The value of GWR-based VRA over scam-based URA

To estimate the bias in the estimation of the economic value of GWR-based VRA, the true per-ha net revenues ("profits") of the SCAM-based URA and GWR-based VRA were calculated by substituting the estimated optimal nitrogen rates into the "true" yield response functions. Profits from the SCAM approach were

$$\Pi_{scam}^* = 1/8640 \sum_{j=1}^{1440} \sum_{k=1}^6 \big[pf_{j, k} (\hat{N}_{scam}^* )-w\hat{N}_{scam}^*\big]$$

where $f_{j, k}(\cdot)$ denotes the true yield response function at cell $(j, k)$.

For $m = R, T$, the true per-ha net revenues ("profits") resulting from applying the profit-maximizing cell-specific N rate plan estimated by GWR-m were,

$$\Pi_{gwr-m}=1/8640 \sum_{j=1}^{1440} \sum_{k=1}^6 [pf_{j, k} (\hat{N}_{gwr-m, j}^*)-w\hat{N}_{gwr-m,j}^*]$$

where $f_{j, k} (\hat{N}_{gwr-j}^*)$ denote the true yield generated at cell $(j, k)$ with subplot $l$'s N rate.

The true value of the GWR-based VRA compared to the SCAM-based URA is defined by the difference of their partial profits:

$$\Delta_{gwr-m} = \Pi_{gwr-m} - \Pi_{scam} .$$

To find the bias in estimating the value of VRA, the profits of the SCAM-based URA and GWR-based VRA were calculated by substituting the estimated optimal nitrogen rates into the cell-specific yield response functions estimated by GWR. Estimated per-ha net revenues for SCAM-based URA and GWR-based VRA are found as follows:

$$\hat{\Pi}_{scam}^* = 1/8640 \sum_{j=1}^{1440} \sum_{k=1}^6 \big[p\hat{f}^{gwr}_{j, k} (\hat{N}_{scam}^* )-w\hat{N}_{scam}^*\big]$$

$$\hat{\Pi}_{gwr-m}^*=1/8640 \sum_{j=1}^{1440} \sum_{k=1}^6 [p\hat{f}^{gwr-m}_{j, k} (\hat{N}_{gwr-m}^{j*} )-w\hat{N}_{gwr-m}^{j*}]$$

The estimated value of the GWR-based VRA compared to the SCAM-based URA is defined as

$$\hat{\Delta}_{gwr-m} = \hat{\Pi}_{gwr-m}^* - \hat{\Pi}_{scam}^*$$

Finally, the bias in the estimation of the value of GWR-based VRA was calculated as follows:

$$bias = \hat{\Delta}_{gwr-m} - \Delta_{gwr-m}$$

# Results

## Comparing the values of GWR-based VRA and SCAM-based URA

Figure \@ref(fig:pi-dif-dist) shows the distribution of $\Delta_{gwr-m}$, the true profit difference between the GWR-based VRA and the SCAM-based URA, at various price scenarios. The comparative advantage of GWR-R and GWR-T varies significantly depending on nitrogen-corn price ratio. Specifically, GWR-R performs better as the price ratio increases (as nitrogen becomes more expensive relative to corn), while the opposite is the case for GWR-T. At the low price ratio of 4.16 and 5.44, VRA based on GWR-R is no better than SCAM-based URA. However, when the price ratio is $10.35$, the median benefit of GWR-R is `r round(mean_data_value[type == "GWR-R" & pLabel == "10.35", pi_diff], digits = 2)`. On the other hand, the median benefit of VRA based on GWR-T when the price ratio is 4.16 is `r round(mean_data_value[type == "GWR-T" & pLabel == "4.16", pi_diff], digits = 2)`, but the its benefit is even negative at `r round(mean_data_value[type == "GWR-T" & pLabel == "10.35", pi_diff], digits = 2)` when the price ratio is 10.35. 

Figure \@ref(fig:bias-est-eonr) provides insights into this phenomenon, showing the distribution of the average ratio of estimated EONR to true EONR. A value lower than 1 means EONR is underestimated on average. GWR-R tends to over-estimate EONR at lower price ratios, but the magnitude of over-estimation goes down as the price ratio goes up. The opposite trend is true for GWR-T. At the price ratio of 10.35, the degree of EONR over-estimation is quite significant. Since a high-price ratio means nitrogen is relatively expensive, the economic cost of over-estimation of EONR increases with the price ratio.

To illustrate the difference in the GWR-R and GWR-T outcomes, Figure \@ref(fig:true-vs-estimated-optn-gwr-r) presents for a single simulation round the estimated site-specific EONR plotted against the true site-specific EONR. The site-specific EONR estimates are both inaccurate, but differently inaccurate. The range of EONR estimates by GWR-R is very wide because the coefficient on $N^2$ is allowed to vary site specifically in GWR-R. Since the estimation of the coefficient on $N^2$ is highly inaccurate, the range of estimated EONRs is much wider than the range of true site-specific EONR. But, GWR-T's range of EONR estimates is very narrow because the coefficient on $N^2$ is constrained to be equal across sites, making GWR-T fail to capture the EONR's true heterogeneity. 


## Bias in the estimation of the value of GWR-based VRA

Next, we examine the bias in the estimated value of GWR-based VRA. Figure \@ref(fig:bias-est-pi) shows the distribution of the bias in the estimation of the profit difference from GWR-based VRA and SCAM-based URA (profit difference between the GWR-based VRA and SCAM-based URA). For example, the value of 10 would mean that the estimated value of GWR-based VRA over-estimates its true value by $10 per ha. As the figure suggests, VRA based on GWR-R appears to perform overwhelmingly better than it truly is, presenting significant positive bias across the price range. That is, researchers would tend to significantly over-estimate the value of VRA based on GWR-R. When the GWR estimates are considered to define true yield response, the inaccuracy of GWR-R generates over-estimation of the heterogeneity of yield response within the field, which can lead to significant over-estimation of the value of GWR-R itself. 

GWR-T exhibits a different pattern of bias. At low price ratios, the GWR-T approach has smaller bias compared to GWR-R. This is partially because GWR-T tends to understate the heterogeneity of site-specific yield response function as was seen in figure \@ref(true-vs-estimated-optn-gwr-r). As the price ratio rises, bias increases. This is due to the significant over-estimation of EONR by GWR-T, as illustrated by figure \@ref(fig:bias-est-eonr). Unlike the GWR-R approach, the distribution of the bias by the GWR-T approach has a fat tail, indicating that there is a greater chance of encountering large positive bias in the estimated value of VRA over URA.

Figure \@ref(fig:why-bias-many) illustrates how over-estimation of the value of VRA can occur. It shows yield response functions estimated by GWR-T and estimated yields associated with the GWR-based EONR rates and SCAM-based EONR rates for 50 randomly chosen cells in a single simulation. Since GWR-based EONRs were obtained assuming the yield response functions estimated by GWR, by construction they out-perform the SCAM-based estimates in every cell. For many cells, the SCAM-based estimated EONR is significantly higher than the actual yield-maximizing N rate, resulting in an estimated yield far lower because of the quadratic functional form assumption. Figure \@ref(fig:why-bias-single) focuses on a single cell and compares estimated and true yields between GWR and SCAM (panel (a)) and estimated and true profits between GWR and SCAM (panel (b)). The cell's true yield response functions plateaus at a nitrogen rate of about $140$ kg ha$^{-1}$, but the GWR-estimated yield response function suggests that yield should peak at a nitrogen rate of about $190$ kg ha$^{-1}$ and thereafter decline. In reality, the yield differential between GWR and SCAM is 0, while the estimated yield differential is about $0.25$ ton ha$^{-1}$, leading to the over-estimation of the value of GWR in panel (b). Based on the true profit response curve, applying the GWR-based recommendation is about \$`r round(- true_yield_data[type != "True", diff(profit)], digits = 0)` ha$^{-1}$ more profitable than applying the SCAM-based recommendation. This profit differential comes solely from the difference in nitrogen cost since GWR and SCAM yields are equal. However, if calculations are based on the cell's GWR-based estimation of the response function, profits from the GWR-based recommendation are measured to exceed those from the SCAM-based recommendation by about \$`r round(- point_data_gwr[, diff(profit)], digits = 0)` ha$^{-1}$. Beyond the difference in nitrogen cost, the falsely estimated yield boost by GWR contributes to the profit differential, thus significantly over-estimating the actual value of GWR.

# Discussions

Our simulation results show that generating site-specific $R_x$s by applying the basic GWR model (GWR-R) to OFPE data tends to have little economic value for site-specific $R_x$s. The GWR-R based VRA is on average no more profitable than SCAM-based URA under many price scenarios, particularly when nitrogen price is relatively low compared to the corn price. This finding reveals the economic consequences of the widely recognized statistical inaccuracy issue of GWR estimation [@griffith2008spatial; @paez2011simulation; @da2016multiple; @harris2019simulation], and is in agreement with previous critiques concluding that GWR should be used as an exploratory tool rather than an inferential tool [@wheeler2005multicollinearity; @paez2011simulation]. Precision agriculture practitioners should be cautious when using GWR for site-specific $R_xs$. If GWR-based approach must be employed to find site-specific input recommendations (e.g., due to lack of field and soil information), our simulation results show that GWR-T performs relatively better than GWR-R, though its profitability improvement against URA is only moderate.

An obvious cause of the GWR models' poor economic performances in this work is that their assumed quadratic functional form of yield response differs from the true quadratic-plateau yield response functions. One solution could be to upgrade to nonlinear GWR models. @lambert2022geographically have recently developed a linear-plateau GWR model, which could be worthy of future examinations of its economic value. Another solution is to extend the parametric GWR approaches to a semi-parametric or non-parametric GWR where the yield response functions are estimated without assuming particular functional forms (like SCAM). However, such a method may well encounter a very similar problem to that faced by GWR-R: insufficient information available locally to estimate reliably the shape of local yield response curves. It is also noted that the recently developed multi-scale GWR model [@fotheringham2017multiscale; @yu2020inference; @comber2022route] allows the bandwidth to be derived separately for each covariate in the model, which would potentially improve the performances of GWR estimates and be incorporated into future research. Please note, however, that multi-scale GWR models are not necessary in our simulations as we have only one covariate ($N$) in our simulations.

Most important, whether using GWR-R or GWR-R, researchers must be cautious about their estimated value of VRA. Our results show that it is likely that they will over-estimate their true values and the bias can be misleadingly high with non-negligible probability. The extremely high values of VRA reported in @trevisan2021spatial are likely to have reflected this bias. Indeed, the bias problem we have raised here is likely to be observed for other statistical methods because the bias comes from the assumption that the _estimated_ yield response functions are true. Whatever the underlying statistical method for yield response functions may be, researchers are likely to overestimate the true value of their methods. It would be an interesting future research to investigate the bias in other major statistical methods that are commonly used in the literature.   

# Conclusions

This article examined the economic value of GWR-based VRA and the bias in its estimation in the context of OFPE. We showed that VRA based on GWR provides only small economic benefits over URA based on SCAM. The relative performances of the model specifications used by @trevisan2021spatial and @rakshit2020 differs based on nitrogen-corn price ratio. Finally and most important, we found that both specifications can result in significant over-estimation of the true value of GWR-based site-specific nitrogen rate recommendations. It can be concluded that researchers need to be cautious about promoting the GWR-based approach to VRA recommendation.

`r run_pagebreak()`

# Figures

```{r fig.id = "field-layout", fig.cap = "Simulated field layout with spatial unit definitions", fig.dim = c(6, 6)}
g_layout
```

```{r fig.id = "field-N-design", fig.cap = "Experiment design of nitrogen (N) rates", fig.dim = c(6, 3.5)}
g_exp
```

```{r, fig.id = "pi-dif-dist", fig.cap = "The value of GWR-based VRA over SCAM-based URA for GWR-R and GWR-T", fig.height = 5, fig.width = 6}
g_value
```

```{r fig.id = "true-vs-estimated-coef-gwr-r", fig.cap = "Comparison of Estimated and True Coefficients", eval = F}
g_comp_coef
```

```{r fig.id = "true-vs-estimated-optn-gwr-r", fig.cap = "Comparison of Estimated and True EONR"}
g_comp_eonr
```

```{r fig.id = "bias-est-eonr", fig.cap = "Average bias in the estimation of EONR by GWR-R and GWR-T", fig.height = 5, fig.width = 6}
g_eonr_bias
```

```{r fig.id = "bias-est-pi", fig.cap = "Bias in the estimation of the value of GWR-based VRA over SCAM-based URA for GWR-R and GWR-T", fig.height = 5, fig.width = 6}
g_bias
```

```{r fig.id = "why-bias-many", fig.cap = "The cause of significant over-estimation of the value of GWR-based VRA"}
g_why_bias_many
```

```{r fig.id = "why-bias-single", fig.cap = "An illustration of over-estimation of the value of GWR-based VRA over SCAM-based URA",fig.dim = c(6, 7)}
g_why_bias_single
```

`r run_pagebreak()`

# References

<br />

<div id="refs"></div>

